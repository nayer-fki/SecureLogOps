input {
  beats { port => 5044 }
}

filter {
  mutate {
    add_field => {
      "env" => "dev"
      "[service][name]" => "host-syslog"
      "[log][level]" => "INFO"
      "source" => "filebeat"
    }
  }

  # لو filebeat عطاك log.level استعمله
  if [log][level] {
    mutate { replace => { "[log][level]" => "%{[log][level]}" } }
  }

  # لو filebeat عطاك host.name خليه service.name
  if [host][name] {
    mutate { replace => { "[service][name]" => "%{[host][name]}" } }
  }

  # extra metadata (اختياري)
  if [agent][type] { mutate { add_field => { "[extra][agent_type]" => "%{[agent][type]}" } } }
  if [host][name]  { mutate { add_field => { "[extra][host_name]"  => "%{[host][name]}" } } }
  if [log][file][path] { mutate { add_field => { "[extra][log_file]" => "%{[log][file][path]}" } } }

  # نظّف strings اللي شكلها %{...} (إذا الحقول موش موجودة)
  mutate {
    gsub => [
      "[extra][agent_type]", "%\{\[[^\]]+\](\[[^\]]+\])*\}", "",
      "[extra][host_name]",  "%\{\[[^\]]+\](\[[^\]]+\])*\}", "",
      "[extra][log_file]",   "%\{\[[^\]]+\](\[[^\]]+\])*\}", ""
    ]
  }
}

output {
  http {
    url => "http://ingest-service:8000/logs"
    http_method => "post"
    format => "json"
    headers => {
      "X-API-Key" => "${INGEST_API_KEY}"
      "Content-Type" => "application/json"
    }
  }

  stdout { codec => rubydebug }
}
